name: Code Coverage

on:
  push:
    branches: [ "main" ]
    paths-ignore: "**/coverage.csv"
  pull_request:
    branches: [ "main" ]

jobs:
  address_sanitizer:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04]
        build_type: [Debug]
        c_compiler: [gcc]
        include:
          - os: ubuntu-24.04
            c_compiler: gcc
            cpp_compiler: g++
            shell: bash
    
    steps:
    - uses: actions/checkout@v4
    - uses: ./.github/actions/build-project
      with: 
        project-name: "project"
        c-compiler: ${{ matrix.c_compiler }}
        cpp-compiler: ${{ matrix.cpp_compiler }}
        build-type: ${{ matrix.build_type }}
        shell-name: ${{ matrix.shell }}
        cmake-config-args: -Dproject_CODE_COVERAGE=ON
    
    - name: Run LCOV
      working-directory: ${{ github.workspace }} 
      run: lcov -d build/src/CMakeFiles/project.dir -c -o coverage.info

    - name: Make Badge
      uses: GoogleCloudPlatform/lcov-coverage-badge@v1.0.1
      with:
        file: ${{ github.workspace }}/coverage.info
        access_token: ${{ secrets.GITHUB_TOKEN }}
        warning: 90
        critical: 85