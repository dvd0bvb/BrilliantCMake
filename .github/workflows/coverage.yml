name: Code Coverage

on:
  push:
    branches: [ "main" ]
    paths-ignore: 
      - .github/badges/**
      - README.md
  pull_request:
    branches: [ "main" ]
    paths-ignore: 
      - .github/badges/**
      - README.md

jobs:
  code_coverage:
    runs-on: ubuntu-24.04
    steps:
    - name: Install LCOV
      run: sudo apt update && sudo apt install lcov

    - uses: actions/checkout@v4
    - uses: ./.github/actions/project-constants
      id: constants
    - uses: ./.github/actions/build-project
      with: 
        c-compiler: gcc
        cpp-compiler: g++
        build-type: Debug
        coverage: true
    
    - name: Run LCOV
      working-directory: ${{ github.workspace }} 
      #TODO project.dir should be replaced by output directory using project name constant
      run: |
        lcov -d build/src/CMakeFiles/${{ steps.constants.outputs.project-name }}.dir -c -o build/coverage.info --branch-coverage
        genhtml build/coverage.info -o docs/coverage --branch-coverage

    - uses: ./.github/actions/parse-coverage
      id: stats
      with:
        lcov-file: ${{ github.workspace }}/build/coverage.info

    - working-directory: ${{ github.workspace }}
      run: >
        curl $(python3 .github/actions/parse-coverage/make-shield-url.py 
        "${{ steps.stats.outputs.line-percent }} ${{ steps.stats.outputs.function-percent }} ${{ steps.stats.outputs.branch-percent }}" 
        95 85)
        > ${{ github.workspace }}/img/coverage.svg

    - uses: oleksiyrudenko/gha-git-credentials@v2-latest
      with:
        token: ${{ github.token }}

    - name: Push coverage badge to github
      shell: bash
      continue-on-error: true
      run: |
        RESULT=$(git diff ${{ github.workspace }}/img/coverage.svg)
        if [ ! -z "$RESULT" ]; then
        git commit ${{ github.workspace }}/img/coverage.svg -m '[skip ci] updated coverage badge from CI action'
        git push
        fi